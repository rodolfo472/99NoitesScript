<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  font-family: Arial;
  background: #0f172a;
  color: white;
}
header {
  background: #020617;
  padding: 10px;
}
#chat {
  height: 60vh;
  padding: 10px;
  overflow-y: auto;
}
.msg {
  margin-bottom: 8px;
}
.user { color: #60a5fa; }
.me { color: #22c55e; }
input, button {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 8px;
}
button { background: #22c55e; }
video {
  width: 48%;
  border-radius: 10px;
  background: black;
}
</style>
</head>
<body>

<header id="top"></header>

<div id="chat"></div>

<input id="msg" placeholder="Mensagem">
<button onclick="enviar()">Enviar</button>

<hr>

<h3>ðŸ“ž Chamada de vÃ­deo</h3>
<input id="numeroLigar" placeholder="NÃºmero do contato">
<button onclick="ligar()">Ligar</button>

<br><br>
<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ðŸ”¥ COLOQUE SEUS DADOS DO FIREBASE
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_PROJETO.firebaseapp.com",
  projectId: "SEU_PROJETO"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const user = JSON.parse(localStorage.getItem("usuario"));
if (!user) location.href = "index.html";

top.innerText = `${user.nome} â€¢ ${user.numero}`;

function enviar() {
  if (!msg.value) return;
  addMsg("VocÃª: " + msg.value, "me");
  msg.value = "";
}

function addMsg(t, c) {
  const d = document.createElement("div");
  d.className = "msg " + c;
  d.innerText = t;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

// ðŸŽ¥ WEBRTC
const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
let pc, localStream;

window.ligar = async function () {
  const destino = numeroLigar.value;
  if (!destino) return alert("Digite o nÃºmero");

  pc = new RTCPeerConnection(servers);
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await setDoc(doc(db, "calls", destino), { offer, from: user.numero });

  onSnapshot(doc(db, "calls", destino), snap => {
    const data = snap.data();
    if (data?.answer && !pc.currentRemoteDescription) {
      pc.setRemoteDescription(data.answer);
    }
  });
};
</script>

</body>
</html>
